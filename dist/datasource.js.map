{"version":3,"file":"datasource.js","names":["_lodash","_interopRequireDefault","require","obj","__esModule","_typeof","Symbol","iterator","constructor","prototype","_classCallCheck","instance","Constructor","TypeError","_defineProperties","target","props","i","length","descriptor","enumerable","configurable","writable","Object","defineProperty","_toPropertyKey","key","_createClass","protoProps","staticProps","arg","_toPrimitive","String","input","hint","prim","toPrimitive","undefined","res","call","Number","GenericDatasource","instanceSettings","$q","backendSrv","templateSrv","type","url","name","db","jsonData","mongodb_url","mongodb_db","q","withCredentials","headers","basicAuth","value","query","options","buildQueryParameters","targets","filter","t","hide","when","data","doRequest","method","testDatasource","then","response","status","message","title","display_status","annotationQuery","replace","annotation","range","datasource","enable","iconColor","rangeRaw","result","$$status","$$config","config","metricFindQuery","interpolated","mapToTextValue","_","map","d","text","isObject","datasourceRequest","_this","scopedVars","refId","exports"],"sources":["../src/datasource.js"],"sourcesContent":["import _ from \"lodash\";\n\nexport class GenericDatasource {\n\n  constructor(instanceSettings, $q, backendSrv, templateSrv) {\n    this.type = instanceSettings.type;\n    this.url = instanceSettings.url;\n    this.name = instanceSettings.name;\n    this.db = { 'url' : instanceSettings.jsonData.mongodb_url, 'db' : instanceSettings.jsonData.mongodb_db }\n    this.q = $q;\n    this.backendSrv = backendSrv;\n    this.templateSrv = templateSrv;\n    this.withCredentials = instanceSettings.withCredentials;\n    this.headers = {'Content-Type': 'application/json'};\n    if (typeof instanceSettings.basicAuth === 'string' && instanceSettings.basicAuth.length > 0) {\n      this.headers['Authorization'] = instanceSettings.basicAuth;\n    }\n  }\n\n  query(options) {\n    var query = this.buildQueryParameters(options);\n    query.targets = query.targets.filter(t => !t.hide);\n    query.db = this.db\n\n    if (query.targets.length <= 0) {\n      return this.q.when({data: []});\n    }\n\n    return this.doRequest({\n      url: this.url + '/query',\n      data: query,\n      method: 'POST'\n    });\n  }\n\n  testDatasource() {\n    return this.doRequest({\n      url: this.url + '/',\n      data : { db : this.db },\n      method: 'POST',\n    }).then(response => {\n      if (response.status === 200) {\n        return { status: response.data.status, message: response.data.message, title: response.data.display_status };\n      }\n    });\n  }\n\n  annotationQuery(options) {\n    var query = this.templateSrv.replace(options.annotation.query, {}, 'glob');\n    var annotationQuery = {\n      range: options.range,\n      annotation: {\n        name: options.annotation.name,\n        datasource: options.annotation.datasource,\n        enable: options.annotation.enable,\n        iconColor: options.annotation.iconColor,\n        query: query\n      },\n      rangeRaw: options.rangeRaw\n    };\n\n    return this.doRequest({\n      url: this.url + '/annotations',\n      method: 'POST',\n      data: annotationQuery\n    }).then(result => {\n      response.data.$$status = result.status;\n      response.data.$$config = result.config;\n    return result.data;\n    });\n  }\n\n  metricFindQuery(query) {\n    var interpolated = {\n        target: this.templateSrv.replace(query, null, '')\n        };\n    interpolated.db = this.db\n\n    return this.doRequest({\n      url: this.url + '/search',\n      data: interpolated,\n      method: 'POST',\n    }).then(this.mapToTextValue);\n  }\n\n  mapToTextValue(result) {\n    return _.map(result.data, (d, i) => {\n      if (d && d.text && d.value) {\n        return { text: d.text, value: d.value };\n      } else if (_.isObject(d)) {\n        return { text: d, value: i};\n      }\n      return { text: d, value: d };\n    });\n  }\n\n  doRequest(options) {\n    options.withCredentials = this.withCredentials;\n    options.headers = this.headers;\n\n    return this.backendSrv.datasourceRequest(options);\n  }\n\n  buildQueryParameters(options) {\n    //remove place holder targets\n    options.targets = _.filter(options.targets, target => {\n      return target.target !== 'select metric';\n    });\n\n    var targets = _.map(options.targets, target => {\n      return {\n        target: this.templateSrv.replace(target.target, options.scopedVars, ''),\n        refId: target.refId,\n        hide: target.hide,\n        type: target.type || 'timeserie'      \n      };\n    });\n\n    options.targets = targets;\n\n    return options;\n  }\n}\n"],"mappings":"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"}